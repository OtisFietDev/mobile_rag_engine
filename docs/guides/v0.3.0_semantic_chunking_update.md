# v0.3.0 Update Guide: Rust Semantic Chunking

This update replaces the Dart-based chunking with a more robust Rust implementation using Unicode segmentation, dramatically improving chunk quality for RAG.

## What Changed

### Before (v0.2.0) - Dart Character Splitting
```dart
// Problem: Chunks could split mid-word or mid-sentence
"...the Korean theater is characterized by a high risk of"
â†“
Chunk 1: "...the Korean theater is characterized by a high risk of"
Chunk 2: " dangerous..."  // âŒ Starts with broken text
```

### After (v0.3.0) - Rust Unicode Segmentation
```dart
// Solution: Respects sentence and word boundaries
"...the Korean theater is characterized by a high risk of asymmetric warfare."
â†“
Chunk 1: "...characterized by a high risk of asymmetric warfare."  // âœ… Complete sentence
Chunk 2: "Chemical, Biological, Radiological, and Nuclear..."    // âœ… Fresh start
```

## Technical Implementation

### 1. New Rust API (`semantic_chunker.rs`)
```rust
// Uses text-splitter crate with ICU Unicode boundaries
pub fn semantic_chunk_with_overlap(
    text: String,
    max_chars: i32,
    overlap_chars: i32,
) -> Vec<SemanticChunk>
```

**Supported Languages:**
- ğŸ‡°ğŸ‡· Korean (ì¡°ì‚¬/ì–´ë¯¸ ê²½ê³„ ì¸ì‹)
- ğŸ‡¯ğŸ‡µ Japanese (åŠ©è© ê²½ê³„)
- ğŸ‡¨ğŸ‡³ Chinese (ë‹¨ì–´ ê²½ê³„)
- ğŸ‡¬ğŸ‡§ English, ğŸ‡©ğŸ‡ª German, etc.

### 2. Removed Files
- `lib/services/chunking_service.dart` - Replaced by Rust API

### 3. Updated Files
- `SourceRagService` - Now uses `semanticChunkWithOverlap()`
- `mobile_rag_engine.dart` - Exports `semantic_chunker.dart`

## Migration

### Constructor Change
```dart
// Before (v0.2.0)
final rag = SourceRagService(
  dbPath: dbPath,
  chunkConfig: ChunkConfig.medium,  // âŒ Removed
);

// After (v0.3.0)
final rag = SourceRagService(
  dbPath: dbPath,
  maxChunkChars: 500,   // âœ… Direct params
  overlapChars: 50,
);
```

### Direct Chunking Access
```dart
// New: Access Rust chunker directly
import 'package:mobile_rag_engine/src/rust/api/semantic_chunker.dart';

final chunks = semanticChunkWithOverlap(
  text: longDocument,
  maxChars: 500,
  overlapChars: 50,
);

for (final chunk in chunks) {
  print('Chunk ${chunk.index}: ${chunk.content}');
  print('Position: ${chunk.startPos} - ${chunk.endPos}');
}
```

## test_app Model Updates

### New LLM Model Options
Added support for larger models with better RAG performance:

| Model | Size | RAG Performance | Platform |
|-------|------|-----------------|----------|
| **Gemma 3n E2B â­** | 3.1GB | âœ…âœ… Good | Mobile & Web |
| Gemma3 4B | 2.6GB | âœ…âœ…âœ… Best | Web Only |
| Gemma3 1B | 555MB | âš ï¸ Limited | Mobile & Web |

### Model Selection Code
```dart
// Models now have webOnly flag
_ModelOption(
  name: 'Gemma 3n E2B IT INT4 â­ (Recommended)',
  url: 'https://huggingface.co/.../gemma-3n-E2B-it-int4.task',
  webOnly: false,  // Available on mobile!
);

// Platform-filtered list
List<_ModelOption> get _models =>
    _allModels.where((m) => kIsWeb || !m.webOnly).toList();
```

## Benefits

1. **Better Chunk Quality** - No more mid-word/sentence splits
2. **Multi-language Support** - Unicode-aware for CJK languages
3. **Larger Model Options** - E2B model for better RAG comprehension
4. **Platform-aware Models** - Web-only models hidden on mobile

## Dependencies Added

```toml
# rust/Cargo.toml
[dependencies]
text-splitter = "0.16"  # Unicode text segmentation
```
